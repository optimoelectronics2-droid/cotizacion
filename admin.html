<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Admin - Trifusion Technologies</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="style.css">
  <!-- Librería para leer Excel en el navegador -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="app">
  <!-- Login -->
  <div class="card" id="loginCard">
    <h1>Admin Trifusion</h1>
    <p class="small">
      Solo para <strong>Trifusion0325</strong>.<br>
      Los clientes usan el <a href="index.html" style="color:#10b981;">cotizador público</a>.
    </p>
    <div class="row">
      <div>
        <label for="username">Correo</label>
        <input id="username" type="email" placeholder="tu-correo-admin">
      </div>
      <div>
        <label for="password">Contraseña</label>
        <input id="password" type="password" placeholder="••••••••">
      </div>
    </div>
    <button class="btn" onclick="login()">Iniciar sesión</button>
  </div>

  <!-- Área admin -->
  <div id="adminArea" style="display:none;">
    <div class="card">
      <div class="flex-between">
        <div>
          <h2>Panel de administración</h2>
          <div class="small">Conectado como <span id="userEmail"></span></div>
        </div>
        <button class="btn-secondary" onclick="logout()">Cerrar sesión</button>
      </div>
    </div>

    <!-- Config de tienda -->
    <div class="card">
      <h3>Datos de la tienda</h3>
      <div class="row">
        <div>
          <label for="storeNameInput">Nombre de la tienda</label>
          <input id="storeNameInput" type="text">
        </div>
        <div>
          <label for="storePhoneInput">Teléfono / WhatsApp</label>
          <input id="storePhoneInput" type="text">
        </div>
      </div>
      <div class="row">
        <div>
          <label for="storeAddressInput">Dirección</label>
          <input id="storeAddressInput" type="text">
        </div>
        <div>
          <label for="logoInput">Logo (imagen)</label>
          <input id="logoInput" type="file" accept="image/*" onchange="handleLogoUpload(event)">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Vista previa logo</label>
          <img id="logoPreview" alt="Logo">
        </div>
      </div>
      <button class="btn" onclick="guardarSettings()">Guardar datos de tienda</button>
    </div>

    <!-- Productos -->
    <div class="card">
      <h3>Productos</h3>
      <div class="row">
        <div>
          <label for="codigoProducto">Código (opcional)</label>
          <input id="codigoProducto" type="text">
        </div>
        <div>
          <label for="nombreProducto">Nombre</label>
          <input id="nombreProducto" type="text">
        </div>
      </div>
      <div class="row">
        <div>
          <label for="precioProducto">Precio (RD$)</label>
          <input id="precioProducto" type="number" step="0.01">
        </div>
        <div>
          <label for="descripcionProducto">Descripción</label>
          <input id="descripcionProducto" type="text">
        </div>
      </div>
      <button class="btn" onclick="crearProducto()">Agregar producto</button>
      <p class="small" style="margin-top:6px;">
        Los productos se guardan en Firestore en la nube.
      </p>

      <hr style="border:none;border-top:1px solid #111827;margin:10px 0;">

      <h4>Carga masiva desde Excel</h4>
      <p class="small">
        Columnas: <strong>nombre</strong>, <strong>precio</strong>, <strong>descripcion</strong>, opcional <strong>codigo</strong>.
      </p>
      <input id="excelInput" type="file" accept=".xlsx" onchange="procesarExcel(event)">
      <p class="small" id="excelStatus"></p>

      <hr style="border:none;border-top:1px solid #111827;margin:10px 0;">

      <h4>Listado de productos</h4>
      <div style="max-height:260px;overflow:auto;border-radius:12px;border:1px solid #111827;">
        <table>
          <thead>
          <tr>
            <th>Nombre</th>
            <th class="text-right">Precio</th>
            <th class="text-center">Código</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="tablaProductos"></tbody>
        </table>
      </div>
    </div>

    <!-- Cotizaciones -->
    <div class="card">
      <h3>Cotizaciones recientes</h3>
      <p class="small">Cotizaciones guardadas desde el cotizador público.</p>
      <div style="max-height:260px;overflow:auto;border-radius:12px;border:1px solid #111827;">
        <table>
          <thead>
          <tr>
            <th>Cliente</th>
            <th>Teléfono</th>
            <th class="text-right">Total</th>
            <th>Fecha</th>
          </tr>
          </thead>
          <tbody id="tablaQuotes"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script src="firebase-config.js"></script>

<script>
  function mostrarAdmin(logged,user){
    document.getElementById('loginCard').style.display = logged ? 'none' : 'block';
    document.getElementById('adminArea').style.display = logged ? 'block' : 'none';
    if (logged && user){
      document.getElementById('userEmail').textContent = user.email;
    }
  }

  async function login(){
    const email = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password){
      alert('Ingresa correo y contraseña.');
      return;
    }
    try{
      const cred = await auth.signInWithEmailAndPassword(email,password);
      mostrarAdmin(true,cred.user);
      cargarTodoAdmin();
    }catch(e){
      console.error(e);
      alert('Error de login: ' + (e.message || ''));
    }
  }

  function logout(){
    auth.signOut();
    mostrarAdmin(false);
  }

  auth.onAuthStateChanged(user=>{
    if (user){
      mostrarAdmin(true,user);
      cargarTodoAdmin();
    }else{
      mostrarAdmin(false);
    }
  });

  async function cargarTodoAdmin(){
    await Promise.all([
      cargarSettingsAdmin(),
      cargarProductosAdmin(),
      cargarQuotesAdmin()
    ]);
  }

  async function cargarSettingsAdmin(){
    try{
      const docRef = db.collection('settings').doc('principal');
      const snap = await docRef.get();
      if (snap.exists){
        const data = snap.data();
        document.getElementById('storeNameInput').value = data.store_name || '';
        document.getElementById('storePhoneInput').value = data.phone || '';
        document.getElementById('storeAddressInput').value = data.address || '';
        if (data.logo){
          const img = document.getElementById('logoPreview');
          img.src = data.logo;
          img.style.display = 'block';
          img.dataset.base64 = data.logo;
        }
      }
    }catch(e){
      console.error('Error cargando settings admin:', e);
    }
  }

  function handleLogoUpload(e){
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      const img = document.getElementById('logoPreview');
      img.src = ev.target.result;
      img.style.display = 'block';
      img.dataset.base64 = ev.target.result;
    };
    reader.readAsDataURL(file);
  }

  async function guardarSettings(){
    const nombre = document.getElementById('storeNameInput').value.trim();
    const phone = document.getElementById('storePhoneInput').value.trim();
    const address = document.getElementById('storeAddressInput').value.trim();
    const img = document.getElementById('logoPreview');
    const logo = img.dataset.base64 || null;

    try{
      await db.collection('settings').doc('principal').set({
        store_name:nombre || 'Trifusion Technologies',
        phone:phone || '829-872-5163',
        address:address || 'Autopista de San Isidro',
        logo:logo || null,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});
      alert('Datos de tienda guardados.');
    }catch(e){
      console.error('Error guardando settings:', e);
      alert('Error al guardar datos de tienda.');
    }
  }

  async function cargarProductosAdmin(){
    try{
      const snap = await db.collection('products').orderBy('createdAt','desc').get();
      const tbody = document.getElementById('tablaProductos');
      tbody.innerHTML = '';
      snap.forEach(doc=>{
        const d = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.name}</td>
          <td class="text-right">RD$ ${(Number(d.price)||0).toFixed(2)}</td>
          <td class="text-center">${d.code || ''}</td>
          <td class="text-right">
            <button class="btn-danger" style="padding:3px 8px;font-size:11px;" onclick="borrarProducto('${doc.id}')">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }catch(e){
      console.error('Error cargando productos:', e);
    }
  }

  async function crearProducto(){
    const code = document.getElementById('codigoProducto').value.trim();
    const name = document.getElementById('nombreProducto').value.trim();
    const precioRaw = document.getElementById('precioProducto').value;
    const description = document.getElementById('descripcionProducto').value.trim();
    const price = parseFloat(String(precioRaw).replace(',','.'));

    if (!name || isNaN(price)){
      alert('Nombre y precio válidos requeridos.');
      return;
    }

    try{
      await db.collection('products').add({
        code: code || null,
        name,
        price,
        description: description || '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('Producto creado.');
      document.getElementById('codigoProducto').value='';
      document.getElementById('nombreProducto').value='';
      document.getElementById('precioProducto').value='';
      document.getElementById('descripcionProducto').value='';
      cargarProductosAdmin();
    }catch(e){
      console.error('Error creando producto:', e);
      alert('Error al crear producto.');
    }
  }

  async function borrarProducto(id){
    if (!confirm('¿Eliminar este producto?')) return;
    try{
      await db.collection('products').doc(id).delete();
      cargarProductosAdmin();
    }catch(e){
      console.error('Error borrando producto:', e);
      alert('Error eliminando producto.');
    }
  }

  function procesarExcel(e){
    const file = e.target.files[0];
    if (!file) return;
    const status = document.getElementById('excelStatus');
    status.textContent = 'Procesando archivo...';

    const reader = new FileReader();
    reader.onload = (ev)=>{
      const data = new Uint8Array(ev.target.result);
      const workbook = XLSX.read(data,{type:'array'});
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet,{defval:''});
      const productos = [];

      rows.forEach(r=>{
        const nombre = r.nombre || r.Nombre || r.NOMBRE || '';
        const precioRaw = r.precio || r.Precio || r.PRECIO || '';
        const descripcion = r.descripcion || r.Descripcion || r.DESCRIPCION || '';
        const codigo = r.codigo || r.Codigo || r.CÓDIGO || '';
        const precio = parseFloat(String(precioRaw).toString().replace(',','.'));
        if (nombre && !isNaN(precio)){
          productos.push({
            code: codigo || null,
            name: String(nombre),
            price: precio,
            description: String(descripcion)
          });
        }
      });

      if (!productos.length){
        status.textContent = 'No se encontraron productos válidos.';
        return;
      }

      enviarBulk(productos);
    };
    reader.readAsArrayBuffer(file);
  }

  async function enviarBulk(productos){
    const status = document.getElementById('excelStatus');
    try{
      const batch = db.batch();
      productos.forEach(p=>{
        const ref = db.collection('products').doc();
        batch.set(ref,{
          code: p.code || null,
          name: p.name,
          price: p.price,
          description: p.description || '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
      await batch.commit();
      status.textContent = `Se insertaron ${productos.length} productos.`;
      cargarProductosAdmin();
    }catch(e){
      console.error('Error bulk:', e);
      status.textContent = 'Error al insertar productos.';
    }
  }

  async function cargarQuotesAdmin(){
    try{
      const snap = await db.collection('quotes')
        .orderBy('createdAt','desc')
        .limit(50)
        .get();
      const tbody = document.getElementById('tablaQuotes');
      tbody.innerHTML = '';
      snap.forEach(doc=>{
        const d = doc.data();
        const fecha = d.quote_date || (d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toISOString().slice(0,10) : '');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.client_name || ''}</td>
          <td>${d.phone || ''}</td>
          <td class="text-right">RD$ ${(Number(d.total)||0).toFixed(2)}</td>
          <td>${fecha}</td>
        `;
        tbody.appendChild(tr);
      });
    }catch(e){
      console.error('Error cargando quotes:', e);
    }
  }
</script>
</body>
</html>
